<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remanejamento</title>
    <link rel="icon" href="https://img.icons8.com/fluency/48/paper-plane.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4361ee; --primary-light: #4895ef; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --bg: #f8faff; --card: #ffffff; --text-main: #2b2d42; --text-sub: #8d99ae;
            --dark-header: #1a1c23;
            --gold: linear-gradient(135deg, #ffd700, #ffb700);
            --silver: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            --bronze: linear-gradient(135deg, #cd7f32, #a0522d);
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 25px; }
        .app-layout { max-width: 1500px; margin: auto; display: grid; grid-template-columns: 1fr 340px; gap: 25px; }

        .app-header { 
            grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; background: var(--dark-header); padding: 20px 30px; border-radius: 16px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        }
        .app-title h1 { 
            margin: 0; font-size: 20px; font-weight: 400; color: #ffffff; 
            letter-spacing: 6px; text-transform: uppercase; 
        }

        .kpi-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border-bottom: 3px solid #eee; }
        .kpi-card h3 { margin: 0; font-size: 11px; text-transform: uppercase; color: var(--text-sub); }
        .kpi-card .value { font-size: 28px; font-weight: 800; display: block; margin-top: 8px; }

        .insert-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .input-group input, .input-group select { padding: 12px; border: 1px solid #edf2f7; border-radius: 10px; font-size: 14px; background: #fcfdfe; transition: 0.3s; width: 100%; box-sizing: border-box; text-transform: uppercase; }
        .input-group input:focus, .input-group select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }

        .search-area { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .search-wrapper { position: relative; flex-grow: 1; }
        .search-wrapper i { position: absolute; left: 15px; top: 14px; color: var(--text-sub); }
        .search-wrapper input { width: 100%; padding: 12px 12px 12px 45px; border: 1px solid #edf2f7; border-radius: 12px; font-size: 14px; box-sizing: border-box; text-transform: uppercase; }

        .multi-filter {
            position: relative;
            min-width: 200px;
        }
        .multi-filter-btn {
            width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #edf2f7; 
            background: white; cursor: pointer; font-size: 12px; font-weight: 700; 
            color: var(--text-sub); transition: 0.3s; text-transform: uppercase;
            text-align: left; display: flex; justify-content: space-between; align-items: center;
        }
        .multi-filter-content {
            display: none; position: absolute; top: 110%; left: 0; width: 100%;
            background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 100; max-height: 250px; overflow-y: auto; padding: 10px; border: 1px solid #edf2f7;
        }
        .multi-filter-content label {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            font-size: 12px; font-weight: 600; color: var(--text-main); cursor: pointer;
            border-radius: 6px; transition: 0.2s;
        }
        .multi-filter-content label:hover { background: #f0f4ff; }
        .multi-filter-content input { width: 16px; height: 16px; cursor: pointer; }

        .filter-btn { padding: 12px 15px; border-radius: 12px; border: 1px solid #edf2f7; background: white; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--text-sub); transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .filter-btn.active.success { background: var(--success); border-color: var(--success); }

        .table-container { background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow: hidden; }
        .scroll-table { max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 15px; background: #fcfdfe; font-size: 11px; color: var(--text-sub); text-transform: uppercase; position: sticky; top: 0; z-index: 5; border-bottom: 1px solid #f1f4f8; text-align: left; }
        td { padding: 14px 15px; border-bottom: 1px solid #f8fafc; font-size: 14px; }

        input[type="time"] {
            border: 1px solid #e2e8f0; border-radius: 8px; padding: 5px 8px;
            font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600;
            color: var(--text-main); background: #f8fafc; cursor: pointer; font-variant-numeric: tabular-nums;
        }

        .btn-time-pill { 
            background: #eef2ff; color: var(--primary); border: none; padding: 6px 14px; border-radius: 20px; 
            font-size: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; display: inline-flex; 
            align-items: center; gap: 4px; text-transform: uppercase; margin-top: 5px; width: 100%; justify-content: center;
        }
        .btn-time-pill:hover { background: var(--primary); color: white; transform: translateY(-1px); }

        .btn-confirm-edit {
            background: var(--success); color: white; border: none; padding: 4px 8px; border-radius: 6px;
            cursor: pointer; font-size: 12px; margin-left: 5px; display: none;
        }

        .action-btns { display: flex; gap: 8px; align-items: center; }
        .btn-reset-tool { 
            border: none; background: #f1f5f9; color: var(--text-sub); 
            width: 32px; height: 32px; border-radius: 8px; cursor: pointer; 
            transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 14px;
        }
        .btn-reset-tool:hover { background: var(--primary); color: white; }
        .btn-reset-tool.danger-hover:hover { background: var(--danger); color: white; }

        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; }
        .toast { 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 16px 24px; border-radius: 16px; min-width: 300px;
            display: flex; align-items: center; gap: 14px; 
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            animation: toastIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            font-weight: 700; font-size: 13px; color: var(--text-main);
            border-left: 6px solid #ccc;
        }
        @keyframes toastIn { from { transform: translateX(120%) scale(0.9); opacity: 0; } to { transform: translateX(0) scale(1); opacity: 1; } }
        .toast.success { border-left-color: var(--success); color: #065f46; }
        .toast.error { border-left-color: var(--danger); color: #991b1b; }
        .toast.warning { border-left-color: var(--warning); color: #92400e; }
        
        #custom-confirm {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 10000; align-items: center; justify-content: center;
        }
        .modal-card {
            background: white; padding: 30px; border-radius: 20px; width: 380px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-card i { font-size: 50px; color: var(--warning); margin-bottom: 15px; display: block; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #f1f4f8; color: var(--text-sub); }

        .active-item { border-left: 3px solid var(--primary); padding: 10px; background: #f0f4ff; border-radius: 8px; margin-bottom: 8px; font-size: 12px; line-height: 1.4; }
        .active-item b { color: var(--primary); }
        .active-item small { color: var(--text-sub); font-weight: 600; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        
        .sidebar-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 25px; }
        
        .rank-item { 
            display: flex; align-items: center; padding: 15px; border-radius: 16px; 
            margin-bottom: 12px; background: #ffffff; border: 1px solid #f1f5f9; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .rank-item:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .rank-pos { 
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; font-size: 12px; font-weight: 800; margin-right: 15px; 
            background: #f1f5f9; color: var(--text-sub); flex-shrink: 0;
        }
        .pos-1 { background: var(--gold); color: white; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3); }
        .pos-2 { background: var(--silver); color: white; box-shadow: 0 4px 10px rgba(192, 192, 192, 0.3); }
        .pos-3 { background: var(--bronze); color: white; box-shadow: 0 4px 10px rgba(205, 127, 50, 0.3); }
        
        .rank-info { flex-grow: 1; }
        .rank-info b { font-size: 13px; color: var(--text-main); display: block; margin-bottom: 2px; }
        .rank-info small { font-size: 10px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; }
        
        .rank-badge {
            background: #f0f4ff; color: var(--primary); padding: 4px 8px; border-radius: 8px;
            font-size: 11px; font-weight: 800; min-width: 20px; text-align: center;
        }

        .ranking-scroll { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        #ativosList { max-height: 320px; overflow-y: auto; padding-right: 5px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        #historico-page { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #f0f2f5; z-index: 9000; padding: 30px; box-sizing: border-box;
        }
        .hist-content { 
            max-width: 1400px; margin: 0 auto; background: white; height: 100%; 
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .hist-header { 
            padding: 25px 35px; background: var(--dark-header); color: white; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .hist-body { padding: 30px; flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        .hist-controls { 
            display: flex; gap: 20px; margin-bottom: 25px; background: #f8fafc; 
            padding: 15px; border-radius: 15px; align-items: center; 
        }
        .hist-table-wrapper { flex-grow: 1; overflow-y: auto; border-radius: 12px; border: 1px solid #eee; }
        
        .hist-empty { text-align: center; padding: 50px; color: var(--text-sub); }
        .hist-empty i { font-size: 40px; margin-bottom: 10px; display: block; opacity: 0.5; }
    </style>
</head>
<body>

<div id="custom-confirm">
    <div class="modal-card">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <h2 id="confirm-title" style="margin: 0 0 10px; font-size: 18px; color: var(--text-main);">Confirmação</h2>
        <p id="confirm-msg" style="margin: 0 0 25px; font-size: 14px; color: var(--text-sub); line-height: 1.5;">Deseja prosseguir?</p>
        <div class="modal-btns">
            <button class="modal-btn btn-cancel" onclick="closeConfirm(false)">CANCELAR</button>
            <button class="modal-btn btn-confirm" onclick="closeConfirm(true)">CONFIRMAR</button>
        </div>
    </div>
</div>

<div id="toast-box"></div>

<div id="historico-page">
    <div class="hist-content">
        <div class="hist-header">
            <div>
                <h2 style="margin:0; font-size: 18px; letter-spacing: 2px;">HISTÓRICO</h2>
            </div>
            <button class="btn" style="background: rgba(255,255,255,0.1); color: white;" onclick="toggleHistorico()">
                <i class="fa-solid fa-xmark"></i> FECHAR
            </button>
        </div>
        
        <div class="hist-body">
            <div class="hist-controls">
                <div class="input-group" style="flex-direction: row; align-items: center; gap: 15px;">
                    <label style="margin:0; white-space: nowrap;">FILTRAR POR DATA:</label>
                    <input type="date" id="filtroDataHist" onchange="fetchHistorico()" style="width: 200px; padding: 10px; border-radius: 10px; border: 1px solid #edf2f7;">
                </div>
                
                <div class="multi-filter">
                    <button class="multi-filter-btn" onclick="toggleDropdown('dropdownHist')">
                        <span id="labelHist">TODOS OS GRUPOS</span> <i class="fa-solid fa-chevron-down"></i>
                    </button>
                    <div id="dropdownHist" class="multi-filter-content"></div>
                </div>

                <div class="search-wrapper" style="width: 350px; margin-left: 10px;">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchHistInput" placeholder="Pesquisar Remanejo ou Separador..." onkeyup="renderizarHistorico()" style="text-transform: uppercase;">
                </div>
                <div style="flex-grow: 1;"></div>
                <button class="btn" style="background: var(--success); color: white;" onclick="exportarExcelHist()">
                    <i class="fa-solid fa-file-excel"></i> EXPORTAR FILTRADO
                </button>
                <button class="btn" style="background: var(--danger); color: white;" onclick="limparHistorico()">
                    <i class="fa-solid fa-trash-can"></i> LIMPAR HISTÓRICO
                </button>
            </div>

            <div class="hist-table-wrapper">
                <table id="tableHistorico">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Remanejo</th>
                            <th>Grupo</th>
                            <th>Separador</th>
                            <th>Início</th>
                            <th>Fim</th>
                            <th>Duração</th>
                        </tr>
                    </thead>
                    <tbody id="histTableBody"></tbody>
                </table>
                <div id="histEmptyMsg" class="hist-empty" style="display:none;">
                    <i class="fa-solid fa-folder-open"></i>
                    Nenhum registro encontrado para esta busca.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="app-layout">
    <header class="app-header">
        <div class="app-title">
            <h1>Remanejamento</h1>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn" style="background: #3a3b45; color: #fff;" onclick="toggleHistorico()">
                <i class="fa-solid fa-clock-rotate-left"></i> Histórico
            </button>
            <button class="btn" style="background: var(--primary); color: #fff;" onclick="salvarDia()">
                <i class="fa-solid fa-cloud-arrow-up"></i> Salvar Finalizados
            </button>
            <label for="csvFile" class="btn" style="background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); cursor: pointer;">
                <i class="fa-solid fa-file-import"></i> Importar CSV
            </label>
            <input type="file" id="csvFile" style="display:none" accept=".csv" onchange="importarCSV(this)">
            <button class="btn" style="background: rgba(239, 68, 68, 0.15); color: #ff8080;" onclick="limparTudo()">Limpar Parados</button>
        </div>
    </header>

    <main class="main-content">
        <div class="kpi-container">
            <div class="kpi-card"><h3>Parados (Local)</h3><span class="value" id="count-parado">0</span></div>
            <div class="kpi-card" style="border-color: var(--warning)"><h3>Em Aberto</h3><span class="value" id="count-aberto">0</span></div>
            <div class="kpi-card" style="border-color: var(--primary)"><h3>Separadores Ativos</h3><span class="value" id="count-sep-ativos">0</span></div>
            <div class="kpi-card" style="border-color: var(--success)"><h3>Finalizados</h3><span class="value" id="count-finalizado">0</span></div>
        </div>

        <div class="insert-card">
            <div class="form-grid">
                <div class="input-group">
                    <label for="m-remanejo">Nº Remanejo</label>
                    <input type="text" id="m-remanejo" placeholder="456789" onkeydown="pularFoco(event, 'm-grupo')">
                </div>
                <div class="input-group">
                    <label for="m-grupo">Grupo</label>
                    <input type="text" id="m-grupo" placeholder="Ex: Aparelho" onkeydown="pularFoco(event, 'm-skus')">
                </div>
                <div class="input-group">
                    <label for="m-skus">Qtd SKU</label>
                    <input type="number" id="m-skus" placeholder="0" onkeydown="pularFoco(event, 'm-separador')">
                </div>
                <div class="input-group">
                    <label for="m-separador">Separador</label>
                    <input type="text" id="m-separador" placeholder="Nome + Enter" onkeydown="if(event.key==='Enter') adicionarManual()">
                </div>
                <button class="btn btn-add" id="btn-inserir" style="background: var(--primary); color: white;" onclick="adicionarManual()">
                    <i class="fa-solid fa-play"></i> Inserir e Iniciar
                </button>
            </div>
        </div>

        <div class="search-area">
            <div class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Pesquisar..." onkeyup="renderizarTabela()" onkeydown="handleSearchEnter(event)">
            </div>
            <button id="filterAberto" class="filter-btn" onclick="toggleFiltro('aberto')">
                <i class="fa-solid fa-clock"></i> EM ANDAMENTO
            </button>
            <button id="filterFinalizado" class="filter-btn success" onclick="toggleFiltro('finalizado')">
                <i class="fa-solid fa-check-double"></i> FINALIZADOS
            </button>
            
            <div class="multi-filter">
                <button class="multi-filter-btn" onclick="toggleDropdown('dropdownTabela')">
                    <span id="labelTabela">TODOS OS GRUPOS</span> <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div id="dropdownTabela" class="multi-filter-content"></div>
            </div>

            <button class="btn" style="background: var(--success); color: white;" onclick="exportarExcel()">
                <i class="fa-solid fa-file-excel"></i> Exportar
            </button>
        </div>

        <div class="table-container">
            <div class="scroll-table">
                <table>
                    <thead>
                        <tr><th>Remanejo</th><th>Grupo</th><th>Qtd</th><th>Separador</th><th>Início</th><th>Fim</th><th>Duração</th><th>Ações</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <aside class="sidebar">
        <div class="sidebar-card" style="padding: 15px 25px;">
            <label style="font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase;">Filtrar Lateral por Setor</label>
            <div class="multi-filter" style="margin-top: 5px;">
                <button class="multi-filter-btn" onclick="toggleDropdown('dropdownSidebar')">
                    <span id="labelSidebar">TODOS OS SETORES</span> <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div id="dropdownSidebar" class="multi-filter-content"></div>
            </div>
        </div>
        <div class="sidebar-card">
            <h2 style="font-size: 15px; margin-bottom: 20px;"><i class="fa-solid fa-clock" style="color: var(--primary)"></i> Em Andamento</h2>
            <div id="ativosList"></div>
        </div>
        <div class="sidebar-card">
            <h2 style="font-size: 15px; margin-bottom: 20px;"><i class="fa-solid fa-award" style="color: var(--warning)"></i> Ranking</h2>
            <div class="ranking-scroll" id="rankingList"></div>
        </div>
    </aside>
</div>

<script>
    const SUPABASE_URL = 'https://vardymjrmruwzaztlufl.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhcmR5bWpybXJ1d3phenRsdWZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NTUxOTgsImV4cCI6MjA4NzMzMTE5OH0.-XUPlrCIHA2b8--aSGHlKJlBYOUidWRt3YxL8feMjJg';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let dadosLocais = []; 
    let dadosNuvem = []; 
    let historico = [];
    let pendingAction = null;
    let filtroAtivo = null;
    let historicoFiltradoExibicao = [];

    let setoresSelecionadosTabela = [];
    let setoresSelecionadosSidebar = [];
    let setoresSelecionadosHist = [];

    const LOCAL_KEY = 'remanejos_parados';

    function getSetor(grupo) {
        return (grupo || "").split('-')[0].trim().toUpperCase();
    }

    function toggleDropdown(id) {
        const drop = document.getElementById(id);
        const allDrops = document.querySelectorAll('.multi-filter-content');
        allDrops.forEach(d => { if(d.id !== id) d.style.display = 'none'; });
        drop.style.display = drop.style.display === 'block' ? 'none' : 'block';
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.multi-filter')) {
            document.querySelectorAll('.multi-filter-content').forEach(d => d.style.display = 'none');
        }
    });

    function atualizarMultiSelect(setores, dropId, selecionados, labelId, callback) {
        const drop = document.getElementById(dropId);
        const label = document.getElementById(labelId);
        if (!drop) return;

        drop.innerHTML = "";
        const sorted = Array.from(setores).sort();
        
        sorted.forEach(s => {
            if (!s) return;
            const isChecked = selecionados.includes(s);
            const item = document.createElement('label');
            item.innerHTML = `<input type="checkbox" value="${s}" ${isChecked ? 'checked' : ''}> ${s}`;
            item.querySelector('input').onchange = (e) => {
                if (e.target.checked) selecionados.push(s);
                else {
                    const idx = selecionados.indexOf(s);
                    if (idx > -1) selecionados.splice(idx, 1);
                }
                label.innerText = selecionados.length > 0 ? `${selecionados.length} SELEC.` : (dropId === 'dropdownSidebar' ? 'TODOS OS SETORES' : 'TODOS OS GRUPOS');
                callback();
            };
            drop.appendChild(item);
        });
    }

    async function fullSync() {
        const { data, error } = await _supabase
            .from('remanejos')
            .select('id, remanejo, grupo, skus, separador, h_ini, h_fim');
        
        if (!error) {
            dadosNuvem = data.map(item => ({
                id: item.id,
                remanejo: String(item.remanejo),
                grupo: item.grupo,
                skus: item.skus,
                separador: item.separador || "",
                hIni: item.h_ini || "",
                hFim: item.h_fim || ""
            }));
            renderizarTabela();
        }
    }

    function setupRealtime() {
        _supabase
            .channel('db-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'remanejos' }, () => {
                fullSync();
            })
            .subscribe();
    }

    async function inicializarDados() {
        const cached = localStorage.getItem(LOCAL_KEY);
        if (cached) dadosLocais = JSON.parse(cached);
        await fullSync();
        setupRealtime();
    }

    async function fetchHistorico() {
        const filtroData = document.getElementById('filtroDataHist').value;
        let query = _supabase.from('historico').select('*');
        if (filtroData) query = query.eq('data', filtroData);
        
        const { data, error } = await query;
        if (!error) {
            historico = data.map(item => ({
                id: item.id,
                remanejo: item.remanejo,
                grupo: item.grupo,
                skus: item.skus,
                separador: item.separador,
                hIni: item.h_ini,
                hFim: item.h_fim,
                data: item.data
            }));
            
            const setoresHist = new Set();
            historico.forEach(item => setoresHist.add(getSetor(item.grupo)));
            atualizarMultiSelect(setoresHist, 'dropdownHist', setoresSelecionadosHist, 'labelHist', renderizarHistorico);
            renderizarHistorico();
        }
    }

    const getHoraLocal = () => new Date().toLocaleTimeString('pt-BR', { hour12: false }).substring(0, 5);
    const getDataLocal = () => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    };
    
    const limparNum = (v) => {
        if (v === null || v === undefined) return "";
        return String(v).replace(/"/g, '').replace(/\./g, '').trim();
    };

    function toggleHistorico() {
        const p = document.getElementById('historico-page');
        const isVisible = p.style.display === 'block';
        p.style.display = isVisible ? 'none' : 'block';
        if(!isVisible) {
            document.getElementById('filtroDataHist').value = getDataLocal();
            fetchHistorico();
        }
    }

    function toggleFiltro(tipo) {
        if(filtroAtivo === tipo) {
            filtroAtivo = null;
            document.getElementById('filterAberto').classList.remove('active');
            document.getElementById('filterFinalizado').classList.remove('active');
        } else {
            filtroAtivo = tipo;
            document.getElementById('filterAberto').classList.toggle('active', tipo === 'aberto');
            document.getElementById('filterFinalizado').classList.toggle('active', tipo === 'finalizado');
        }
        renderizarTabela();
    }

    function pularFoco(event, nextId) { if (event.key === "Enter") { event.preventDefault(); document.getElementById(nextId).focus(); } }

    function handleSearchEnter(event) {
        if (event.key === "Enter") {
            const firstRow = document.querySelector("#tableBody tr");
            if (firstRow) { 
                const inputSep = firstRow.querySelector("td:nth-child(4) input");
                if(inputSep) {
                    inputSep.focus();
                    inputSep.select();
                }
            }
        }
    }

    function notify(msg, type = 'success') {
        const box = document.getElementById('toast-box');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = type === 'success' ? 'fa-circle-check' : (type === 'error' ? 'fa-circle-xmark' : 'fa-triangle-exclamation');
        toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${msg.toUpperCase()}</span>`;
        box.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'toastIn 0.5s reverse forwards'; setTimeout(() => toast.remove(), 500); }, 3000);
    }

    function openConfirm(msg, onConfirm) {
        document.getElementById('confirm-msg').innerText = msg;
        document.getElementById('custom-confirm').style.display = 'flex';
        pendingAction = onConfirm;
    }

    function closeConfirm(result) {
        document.getElementById('custom-confirm').style.display = 'none';
        if (result && pendingAction) pendingAction();
        pendingAction = null;
    }

    function calcularDuracao(ini, fim) {
        if (!ini || !fim) return "--:--";
        const [h1, m1] = ini.split(':').map(Number);
        const [h2, m2] = fim.split(':').map(Number);
        let d = (h2 * 60 + m2) - (h1 * 60 + m1);
        if (d < 0) d += 1440;
        return `${String(Math.floor(d/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
    }

    function verificarTrava(nome, id, callback) {
        if(!nome) return callback(true);
        const nomeNorm = nome.toUpperCase().trim();
        const conflito = dadosNuvem.find(d => d.id !== id && d.separador.toUpperCase() === nomeNorm && d.hFim === "");
        if (conflito) {
            openConfirm(`O COLABORADOR "${nomeNorm}" JÁ ESTÁ NO REMANEJO ${conflito.remanejo}. FINALIZAR ANTERIOR?`, async () => {
                await _supabase.from('remanejos').update({ h_fim: getHoraLocal() }).eq('id', conflito.id);
                callback(true);
            });
            return;
        }
        callback(true);
    }

    async function adicionarManual() {
        const rInput = document.getElementById('m-remanejo'), gInput = document.getElementById('m-grupo'), sInput = document.getElementById('m-skus'), sepInput = document.getElementById('m-separador');
        const r = limparNum(rInput.value), s = sepInput.value.trim().toUpperCase();
        if(!r) return notify("NÚMERO OBRIGATÓRIO", "error");
        if(dadosLocais.some(d => d.remanejo === r) || dadosNuvem.some(d => d.remanejo === r)) return notify("REMANEJO JÁ EXISTE!", "error");
        if(s) {
            verificarTrava(s, null, async (pode) => {
                if(!pode) return;
                const novo = { remanejo: r, grupo: gInput.value.trim().toUpperCase(), skus: sInput.value || 0, separador: s, h_ini: getHoraLocal(), h_fim: null };
                await _supabase.from('remanejos').insert([novo]);
                limparCamposManual();
            });
        } else {
            dadosLocais.push({ id: Date.now(), remanejo: r, grupo: gInput.value.trim().toUpperCase(), skus: sInput.value || 0, separador: "", hIni: "", hFim: "" });
            saveLocal();
            limparCamposManual();
            renderizarTabela();
        }
    }

    function limparCamposManual() {
        document.getElementById('m-remanejo').value = ""; document.getElementById('m-grupo').value = ""; 
        document.getElementById('m-skus').value = ""; document.getElementById('m-separador').value = "";
        document.getElementById('m-remanejo').focus();
    }

    function saveLocal() { localStorage.setItem(LOCAL_KEY, JSON.stringify(dadosLocais)); }

    function mostrarBotaoConfirma(btnId) {
        const btn = document.getElementById(btnId);
        if(btn) btn.style.display = 'inline-block';
    }

    async function confirmarEdicao(id, isLocal, campo, inputId) {
        const input = document.getElementById(inputId);
        const valorRaw = input.value;
        const valorFinal = typeof valorRaw === 'string' ? valorRaw.toUpperCase().trim() : valorRaw;

        if (campo === 'separador' && !valorFinal) {
            desfazerPasso(id, isLocal);
            return;
        }

        if (campo === 'separador' && valorFinal) {
            verificarTrava(valorFinal, id, async (pode) => {
                if(pode) {
                    if(isLocal) {
                        const item = dadosLocais.find(d => d.id == id);
                        const novoParaNuvem = { remanejo: item.remanejo, grupo: item.grupo, skus: item.skus, separador: valorFinal, h_ini: getHoraLocal() };
                        const { error } = await _supabase.from('remanejos').insert([novoParaNuvem]);
                        if(!error) {
                            dadosLocais = dadosLocais.filter(d => d.id != id);
                            saveLocal();
                        }
                    } else {
                        await _supabase.from('remanejos').update({ separador: valorFinal }).eq('id', id);
                    }
                }
            });
        } else {
            if(isLocal) {
                const idx = dadosLocais.findIndex(d => d.id == id);
                dadosLocais[idx][campo] = valorFinal;
                saveLocal();
                renderizarTabela();
            } else {
                let dbCampo = campo === 'hIni' ? 'h_ini' : (campo === 'hFim' ? 'h_fim' : campo);
                await _supabase.from('remanejos').update({ [dbCampo]: valorFinal }).eq('id', id);
            }
        }
        
        const btn = document.getElementById('btn-check-'+campo+'-'+id);
        if(btn) btn.style.display = 'none';
    }

    async function desfazerPasso(id, isLocal) {
        const item = isLocal ? dadosLocais.find(d => d.id == id) : dadosNuvem.find(d => d.id == id);
        if (!item) return;

        if (item.hFim) {
            await editarSimples(id, isLocal, isLocal ? 'hFim' : 'h_fim', null);
            notify("FIM REMOVIDO");
        } else if (item.hIni) {
            await editarSimples(id, isLocal, isLocal ? 'hIni' : 'h_ini', null);
            notify("INÍCIO REMOVIDO");
        } else if (item.separador) {
            if (!isLocal) {
                const itemNuvem = item;
                const paraLocal = { id: Date.now(), remanejo: itemNuvem.remanejo, grupo: itemNuvem.grupo, skus: itemNuvem.skus, separador: "", hIni: "", hFim: "" };
                dadosLocais.push(paraLocal);
                saveLocal();
                await _supabase.from('remanejos').delete().eq('id', id);
                notify("VOLTOU PARA PARADOS", "warning");
            } else {
                const idx = dadosLocais.findIndex(d => d.id == id);
                dadosLocais[idx].separador = "";
                saveLocal();
                renderizarTabela();
                notify("SEPARADOR REMOVIDO");
            }
        }
    }

    async function setHora(id, isLocal, campo) {
        const hora = getHoraLocal();
        if(isLocal && campo === 'hIni') return notify("INSIRA UM SEPARADOR PARA INICIAR", "warning");
        const dbCampo = campo === 'hIni' ? 'h_ini' : 'h_fim';
        await _supabase.from('remanejos').update({ [dbCampo]: hora }).eq('id', id);
    }

    async function editarSimples(id, isLocal, campo, val) {
        const valorFinal = typeof val === 'string' ? val.toUpperCase().trim() : (val === null ? "" : val);
        if(isLocal) {
            const idx = dadosLocais.findIndex(d => d.id == id);
            dadosLocais[idx][campo] = valorFinal;
            saveLocal();
            renderizarTabela();
        } else {
            await _supabase.from('remanejos').update({ [campo]: valorFinal === "" ? null : valorFinal }).eq('id', id);
        }
    }

    function renderizarTabela() {
        const tbody = document.getElementById('tableBody');
        const ativosList = document.getElementById('ativosList');
        const term = limparNum(document.getElementById('searchInput').value).toUpperCase();
        
        tbody.innerHTML = ""; ativosList.innerHTML = "";
        let p=0, a=0, f=0, rankData = {}, sepsAtivos = new Set(), setoresExistentes = new Set();

        const unificados = [
            ...dadosLocais.map(d => ({ ...d, isLocal: true })),
            ...dadosNuvem.map(d => ({ ...d, isLocal: false }))
        ];

        unificados.forEach(item => setoresExistentes.add(getSetor(item.grupo)));
        atualizarMultiSelect(setoresExistentes, 'dropdownSidebar', setoresSelecionadosSidebar, 'labelSidebar', renderizarTabela);
        atualizarMultiSelect(setoresExistentes, 'dropdownTabela', setoresSelecionadosTabela, 'labelTabela', renderizarTabela);

        const finalizados = unificados.filter(i => i.hIni && i.hFim).sort((x, y) => y.hFim.localeCompare(x.hFim));
        const emAndamento = unificados.filter(i => i.hIni && !i.hFim).sort((x, y) => x.hIni.localeCompare(y.hIni));
        const parados = unificados.filter(i => !i.hIni);
        
        const listaOrdenada = [...finalizados, ...emAndamento, ...parados];

        emAndamento.forEach(item => {
            const setorItem = getSetor(item.grupo);
            const matchSidebar = setoresSelecionadosSidebar.length === 0 || setoresSelecionadosSidebar.includes(setorItem);
            const matchTabela = setoresSelecionadosTabela.length === 0 || setoresSelecionadosTabela.includes(setorItem);

            if (matchSidebar && matchTabela) {
                const gPartes = (item.grupo || "").split('-');
                const gExibir = gPartes.length > 1 ? gPartes[1].trim() : gPartes[0].trim();
                ativosList.innerHTML += `
                    <div class="active-item">
                        <b>${item.separador.toUpperCase()}</b><br>
                        Rem: ${item.remanejo} | Qtd: ${item.skus} | ${gExibir}<br>
                        <small>Início: ${item.hIni}</small>
                    </div>`;
            }
        });

        listaOrdenada.forEach(item => {
            const statusAberto = item.hIni && !item.hFim;
            const statusFinalizado = item.hIni && item.hFim;
            const setorItem = getSetor(item.grupo);
            const matchTabela = setoresSelecionadosTabela.length === 0 || setoresSelecionadosTabela.includes(setorItem);
            const matchSidebar = setoresSelecionadosSidebar.length === 0 || setoresSelecionadosSidebar.includes(setorItem);

            if (matchTabela) {
                if(!item.hIni) p++; 
                else if(statusAberto) { a++; sepsAtivos.add(item.separador.toUpperCase()); }
                else if(statusFinalizado) { 
                    f++; 
                    if (matchSidebar && item.separador) {
                        rankData[item.separador.toUpperCase()] = (rankData[item.separador.toUpperCase()] || 0) + 1; 
                    }
                }
            }

            let mostrar = true;
            if(filtroAtivo === 'aberto' && !statusAberto) mostrar = false;
            if(filtroAtivo === 'finalizado' && !statusFinalizado) mostrar = false;
            if(!(item.remanejo.includes(term) || item.separador.toUpperCase().includes(term))) mostrar = false;
            if(!matchTabela) mostrar = false;

            if(mostrar) {
                const tr = document.createElement('tr');
                if(item.hFim) tr.style.background = "#f0fff4";
                else if(item.hIni) tr.style.background = "#fffcf0";
                
                tr.innerHTML = `
                    <td><b>${item.remanejo}</b></td>
                    <td contenteditable="true" onblur="editarSimples('${item.id}', ${item.isLocal}, 'grupo', this.innerText)">${item.grupo}</td>
                    <td><input type="number" value="${item.skus}" onchange="editarSimples('${item.id}', ${item.isLocal}, 'skus', this.value)" style="width:50px; border:none; background:transparent"></td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            <input type="text" id="inp-sep-${item.id}" value="${item.separador}" 
                                oninput="mostrarBotaoConfirma('btn-check-separador-${item.id}')"
                                onkeydown="if(event.key==='Enter') confirmarEdicao('${item.id}', ${item.isLocal}, 'separador', 'inp-sep-${item.id}')"
                                style="border:none; width:100%; background:transparent; text-transform: uppercase" placeholder="Nome + Enter">
                            <button id="btn-check-separador-${item.id}" class="btn-confirm-edit" onclick="confirmarEdicao('${item.id}', ${item.isLocal}, 'separador', 'inp-sep-${item.id}')"><i class="fa-solid fa-check"></i></button>
                        </div>
                    </td>
                    <td>
                        <div style="display:flex; align-items:center; gap:2px;">
                            <input type="time" id="inp-hIni-${item.id}" value="${item.hIni}" oninput="mostrarBotaoConfirma('btn-check-hIni-${item.id}')">
                            <button id="btn-check-hIni-${item.id}" class="btn-confirm-edit" onclick="confirmarEdicao('${item.id}', ${item.isLocal}, 'hIni', 'inp-hIni-${item.id}')"><i class="fa-solid fa-check"></i></button>
                        </div>
                        <button class="btn-time-pill" onclick="setHora('${item.id}', ${item.isLocal}, 'hIni')">INI</button>
                    </td>
                    <td>
                        <div style="display:flex; align-items:center; gap:2px;">
                            <input type="time" id="inp-hFim-${item.id}" value="${item.hFim}" oninput="mostrarBotaoConfirma('btn-check-hFim-${item.id}')">
                            <button id="btn-check-hFim-${item.id}" class="btn-confirm-edit" onclick="confirmarEdicao('${item.id}', ${item.isLocal}, 'hFim', 'inp-hFim-${item.id}')"><i class="fa-solid fa-check"></i></button>
                        </div>
                        <button class="btn-time-pill" onclick="setHora('${item.id}', ${item.isLocal}, 'hFim')">FIM</button>
                    </td>
                    <td style="font-weight:700; color:var(--primary)">${calcularDuracao(item.hIni, item.hFim)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-reset-tool" title="Desfazer Ação" onclick="desfazerPasso('${item.id}', ${item.isLocal})"><i class="fa-solid fa-arrow-rotate-left"></i></button>
                            <button class="btn-reset-tool danger-hover" title="Remover" onclick="remover('${item.id}', ${item.isLocal})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            }
        });

        document.getElementById('count-parado').innerText = p;
        document.getElementById('count-aberto').innerText = a;
        document.getElementById('count-finalizado').innerText = f;
        document.getElementById('count-sep-ativos').innerText = sepsAtivos.size;
        renderRanking(rankData);
    }

    function renderRanking(data) {
        const list = document.getElementById('rankingList');
        if (!list) return;
        list.innerHTML = "";
        const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]);
        sorted.forEach(([nome, qtd], i) => {
            const medalClass = (i === 0) ? 'pos-1' : (i === 1) ? 'pos-2' : (i === 2) ? 'pos-3' : '';
            list.innerHTML += `<div class="rank-item"><div class="rank-pos ${medalClass}">${i+1}</div><div class="rank-info"><b>${nome}</b><small>${qtd} CONCLUÍDOS</small></div><div class="rank-badge">${qtd}</div></div>`;
        });
    }

    async function importarCSV(input) {
        if (!input.files || input.files.length === 0) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const lines = e.target.result.split('\n');
            let novos = 0;
            lines.forEach((line, i) => {
                if(i === 0 || !line.trim()) return;
                const col = line.split(';');
                const r = limparNum(col[3]);
                const jaExisteLocal = dadosLocais.some(d => limparNum(d.remanejo) === r);
                const jaExisteNuvem = dadosNuvem.some(d => limparNum(d.remanejo) === r);
                
                if(r && !jaExisteLocal && !jaExisteNuvem) {
                    dadosLocais.push({ id: Date.now() + i, remanejo: r, grupo: col[5] ? col[5].replace(/"/g,'').split(',')[0].trim().toUpperCase() : "", skus: col[6] ? parseInt(col[6].replace(/"/g,'').trim()) : 0, separador: "", hIni: "", hFim: "" });
                    novos++;
                }
            });
            if(novos > 0) { saveLocal(); renderizarTabela(); notify(`${novos} IMPORTADOS`); }
            else { notify("NENHUM ITEM NOVO", "warning"); }
            input.value = ""; 
        };
        reader.readAsText(input.files[0]);
    }

    async function salvarDia() {
        const finalizados = dadosNuvem.filter(d => d.hFim !== "");
        if(finalizados.length === 0) return notify("NENHUM FINALIZADO NA NUVEM", "warning");
        openConfirm(`SALVAR ${finalizados.length} REGISTROS NO HISTÓRICO?`, async () => {
            const hoje = getDataLocal();
            const inserts = finalizados.map(reg => ({ remanejo: reg.remanejo, grupo: reg.grupo, skus: reg.skus, separador: reg.separador, h_ini: reg.hIni, h_fim: reg.hFim, data: hoje }));
            const { error } = await _supabase.from('historico').insert(inserts);
            if(!error) {
                await _supabase.from('remanejos').delete().in('id', finalizados.map(d => d.id));
                notify("DIA FINALIZADO E SALVO!");
            }
        });
    }

    function renderizarHistorico() {
        const tbody = document.getElementById('histTableBody');
        const emptyMsg = document.getElementById('histEmptyMsg');
        const term = document.getElementById('searchHistInput').value.toUpperCase().trim();
        
        if (!tbody) return;
        tbody.innerHTML = "";
        
        historicoFiltradoExibicao = historico.filter(item => {
            const matchSearch = item.remanejo.includes(term) || item.separador.toUpperCase().includes(term);
            const setorItem = getSetor(item.grupo);
            const matchSetor = setoresSelecionadosHist.length === 0 || setoresSelecionadosHist.includes(setorItem);
            return matchSearch && matchSetor;
        }).sort((a, b) => b.hFim.localeCompare(a.hFim));

        historicoFiltradoExibicao.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><span style="background:#eee; padding:3px 8px; border-radius:5px; font-size:12px;">${item.data.split('-').reverse().join('/')}</span></td><td><b>${item.remanejo}</b></td><td>${item.grupo}</td><td style="color:var(--primary); font-weight:600;">${item.separador}</td><td>${item.hIni}</td><td>${item.hFim}</td><td style="font-weight:700;">${calcularDuracao(item.hIni, item.hFim)}</td>`;
            tbody.appendChild(tr);
        });
        if (emptyMsg) emptyMsg.style.display = historicoFiltradoExibicao.length === 0 ? 'block' : 'none';
    }

    async function remover(id, isLocal) { 
        openConfirm("REMOVER ESTE REGISTRO?", async () => { 
            if(isLocal) { dadosLocais = dadosLocais.filter(d => d.id != id); saveLocal(); renderizarTabela(); }
            else { await _supabase.from('remanejos').delete().eq('id', id); }
            notify("REMOVIDO", "error"); 
        }); 
    }
    
    function limparTudo() { 
        openConfirm("LIMPAR TODOS OS PARADOS (LOCAL)?", () => { 
            dadosLocais = []; localStorage.removeItem(LOCAL_KEY); renderizarTabela(); notify("LISTA LOCAL LIMPA", "warning"); 
        }); 
    }
    
    function exportarExcel() {
        const exportData = [...dadosLocais, ...dadosNuvem].map(d => ({ Remanejo: d.remanejo, Grupo: d.grupo, SKUs: d.skus, Separador: d.separador, Início: d.hIni, Fim: d.hFim, Duração: calcularDuracao(d.hIni, d.hFim) }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(wb, ws, "Fluxo");
        XLSX.writeFile(wb, `Fluxo_${getDataLocal()}.xlsx`);
    }

    function exportarExcelHist() {
        const exportData = historicoFiltradoExibicao.map(d => ({ Data: d.data, Remanejo: d.remanejo, Grupo: d.grupo, Separador: d.separador, Início: d.hIni, Fim: d.hFim, Duração: calcularDuracao(d.hIni, d.hFim) }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(wb, ws, "Historico");
        XLSX.writeFile(wb, `Historico_${getDataLocal()}.xlsx`);
    }

    function limparHistorico() {
        openConfirm("LIMPAR TODO O HISTÓRICO?", async () => {
            await _supabase.from('historico').delete().neq('remanejo', '0');
            fetchHistorico();
            notify("HISTÓRICO APAGADO", "error");
        });
    }

    window.onload = inicializarDados;
</script>
</body>
</html>
